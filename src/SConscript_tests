import os, re, imp

Import('env')

base ='#/src'
target = '#/bin/main'

cppFiles      = Glob('*.cpp')     + Glob('*/*.cpp')     + Glob('*/*/*.cpp')
cppFilesPrune = Glob('main.cpp') + Glob('Test*.cpp') + Glob('*/Test*.cpp') + Glob('*/*/Test*.cpp')
testFiles     = Glob('Test*.h')   + Glob('*/Test*.h')   + Glob('*/*/Test*.h')
sourceFiles = list(set(cppFiles) - set(cppFilesPrune))

# # Macros definitions
cppflags = ['-O0', '-g', '-std=c++11', '-fno-strict-aliasing',
            '-D_REENTRANT', '-DBOOST_FILESYSTEM_NO_DEPRECATED']

macroDefinitions = [
#   'SLOW_TESTS',  # ENABLES SLOW TESTS
]
for macro in macroDefinitions:
   cppflags.append('-D' + macro)

pathBoost = os.environ['BOOSTDIR'];
pathSdl  = os.environ['SDL2DIR'];
pathAngel  = os.environ["ANGELSCRIPTDIR"];
pathCxxTest = os.environ['CXXTESTDIR'];
pathCxxTestBuilder = pathCxxTest + '/build_tools/SCons/'

cppflags.extend(['-isystem', pathSdl + '/include/'])

env_test = env.Clone(tools=['default','cxxtest'],
                     toolpath=['#/common', pathCxxTestBuilder])
env_test.Replace(CXXTEST_INSTALL_DIR = pathCxxTest)
env_test.Replace(CXXTEST_SUFFIX = '.h')
env_test.Replace(CXXFLAGS = ' '.join(cppflags))
env_test.Replace(CXXTEST_CPPPATH = ['#/src', pathCxxTest])
env_test.Replace(CXXTEST_OPTS = '--have-eh')

sourcepaths = [pathBoost + "/include/", pathSdl + '/include/', pathAngel + '/include']
libs = ['main', 'angeladdon', 'SDL2', 'SDL2_image', 'SDL2_ttf', 'SDL2_mixer',
        'angelscript', 'boost_system', 'boost_filesystem',
        'GL', 'GLU']
libpaths = [pathBoost + '/lib', pathSdl + '/lib', pathAngel + '/lib', '#/lib']
env_test.Replace(CPPPATH=sourcepaths)
env_test.Replace(LIBS=libs)
env_test.Replace(LIBPATH=libpaths)
env_test.Replace(CXX=env['CXX'])
for tf in testFiles:
   test = env_test.CxxTest('#/bin/tests/Test' + re.search('.*Test(.+?)\.h',
                                                          str(tf)).group(1), tf)
   Clean(test, '#/build')
   Default(test)
